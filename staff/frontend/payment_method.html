<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>เลือกวิธีชำระเงิน</title>

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai&display=swap" rel="stylesheet">

<style>

body {
	font-family: "Noto Sans Thai";
	background:#f4f6fb;
}

.box {
	max-width:700px;
	margin:100px auto;
	background:white;
	border-radius:18px;
	padding:40px;
	box-shadow:0 10px 30px rgba(0,0,0,.15);
	text-align:center;
}

h2 {
	margin-bottom:10px;
}

.code {
	font-size:30px;
	font-weight:700;
	margin-bottom:30px;
	color:#ff7a00;
}

.btns {
	display:flex;
	gap:20px;
	justify-content:center;
	margin-top:30px;
}

.btn {
	padding:18px 40px;
	font-size:18px;
	border:none;
	border-radius:999px;
	cursor:pointer;
	font-weight:600;
	transition:.15s;
}

.btn:hover {
	transform:scale(1.04);
}

.cash {
	background:#ff8a00;
	color:white;
}

.qr {
	background:#00aa66;
	color:white;
}

</style>
</head>

<body>

<div class="box">

	<h2>เลือกวิธีการชำระเงิน</h2>

	<div>
		Booking Code:
	</div>

	<div class="code" id="bookingCode">
		-
	</div>

	<div class="btns">

		<button class="btn cash" id="cashBtn">
			เงินสด
		</button>

		<button class="btn qr" id="qrBtn">
			QR Code
		</button>

	</div>

</div>

<script>

/* ===============================
   GET BOOKING CODE
================================ */

const params =
	new URLSearchParams(window.location.search);

const code =
	params.get("code");

if (!code) {
	alert("ไม่พบรหัสการจอง");
	location.href = "index.html";
}

document.getElementById("bookingCode")
	.textContent = code;


/* ===============================
   CASH FLOW
================================ */

document.getElementById("cashBtn")
.addEventListener("click", function () {

	const ok =
		confirm(
			"ยืนยันว่าลูกค้าชำระเงินสดเรียบร้อยแล้ว?"
		);

	if (!ok) return;

	fetch(
		"/sports_rental_system/staff/api/confirm_cash_payment.php",
		{
			method: "POST",
			headers: {
				"Content-Type":
					"application/json"
			},
			credentials: "include",
			body: JSON.stringify({
				booking_code: code
			})
		}
	)
	.then(async r => {

		const text = await r.text();

		try {
			return JSON.parse(text);
		} catch (e) {
			console.error("SERVER ERROR:", text);
			alert("เซิร์ฟเวอร์มีปัญหา");
			throw e;
		}
	})
	.then(res => {

		if (!res.success) {
			alert(res.message || "บันทึกไม่สำเร็จ");
			return;
		}

		alert(res.message || "บันทึกเรียบร้อย");

		if (res.redirect) {
			window.location.href = res.redirect;
		} else {
			window.location.href = "bookings.html";
		}
	});
});


/* ===============================
   QR FLOW
================================ */

document.getElementById("qrBtn")
.addEventListener("click", function () {

	window.location.href =
		"qr_payment.html?code=" + code;
});

</script>

</body>
</html>
